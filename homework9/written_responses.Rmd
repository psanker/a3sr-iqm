---
title: "Homework 8"
subtitle: "IQM"
date: "`r strftime(Sys.Date(), format = '%Y-%m-%d')`"
author: Patrick Anker
header-includes:
output: 
  bookdown::pdf_document2:
    includes:
      in_header: "../preamble.tex"
    toc: false
    extra_dependencies: "float"
    number_sections: false
---

```{r setup1, include=FALSE, cache=FALSE}
knitr::read_chunk(here::here("homework9/analysis.R"))

# Allowing code chunk crossreferences
# https://stackoverflow.com/questions/50702942/does-rmarkdown-allow-captions-and-references-for-code-chunks
old_source <- knitr::knit_hooks$get("source")
knitr::knit_hooks$set(source = function(x, options) {
  x <- old_source(x, options)

  if (!is.null(options$code.cap)) {
    x <- paste0("\\label{", options$label, "}", x)
    x <- paste0("\\captionof{chunk}{", options$code.cap, "}", x)
  }

  x
})
```

```{r preamble, include=FALSE}
```

# Question 1

<!--TODO: Add sketches-->

# Question 2

The indicator for `age18_29` is excluded because it acts as the reference class for the binned `age` variable.

<!--TODO: Add sketches-->

# Question 3

<!--TODO: Add sketches-->

Goddamn, why so much drawing this week, Ravi?

# Question 4

<!--TODO: Add sketches-->

# Question 5

```{r question5, include=FALSE}
```

```{r q5f1, echo=FALSE, fig.cap="Examining mortality rate against nitric oxide levels. A simple linear fit is probably not good here.", fig.align="center", fig.subcap=c("Raw data scatterplot", "Residual plot"), fig.ncol=2, out.width="45%"}
plt_q5f1a
plt_q5f1b
```

Fig. \@ref(fig:q5f1) shows that a simple regression `mort ~ nox` would not be a great fit. There is clearly some structure in the data that makes the higher nitric oxide levels more spaced out than the lower ones. Usually this is an indication that a log transformation is needed. From a more scientific point of view, a log transformation would be beneficial anyway as NOX level can be modeled as a Poisson process (number of particulates measured in some period $\tau$).

```{r q5f2, echo=FALSE, fig.cap="Examining mortality rate against log nitric oxide levels.", fig.align="center", fig.subcap=c("Raw data scatterplot", "Residual plot"), fig.ncol=2, out.width="45%"}
plt_q5f2a
plt_q5f2b
```

The variable `mort` seems to be number of deaths in a year per 100,000, so it would also seem plausible that it is also generated by a Poisson process. However, the question is whether the scale factor $\lambda$ is large enough to be approximated by a Normal distribution instead. Fig. \@ref(fig:q5f2) examines the predictive capabilities of `mort ~ log(nox)`, whereas Fig. \@ref(fig:q5f3) examines the capabilities of `log(mort) ~ log(nox)`.

```{r q5f3, echo=FALSE, fig.cap="Examining log mortality rate against log nitric oxide levels.", fig.align="center", fig.subcap=c("Raw data scatterplot", "Residual plot"), fig.ncol=2, out.width="45%"}
plt_q5f3a
plt_q5f3b
```

As the two figures show, the predictive capabilities of both are pretty much identical at this stage, so I will choose the simpler `mort ~ log(nox)` model.

```{r q5t1, echo=FALSE}
kableExtra::kable(
  tab_q5t1,
  escape = FALSE,
  booktabs = TRUE,
  caption = "Estimates for chosen model parameters"
) |>
  kableExtra::kable_styling(latex_options = "hold_position")
```

In Tab. \@ref(tab:q5t1), $\beta_N$ shows that groups of cities that on average differ by a factor of $e$ in nitric oxide levels will have a mortality rate that, on average, differs by `r round(coef(mod_q5_2)[[2]], 2)`.

```{r q5f4, echo=FALSE, fig.cap="Comparison of distributions of pollution levels", fig.align="center", fig.width=7, fig.height=3, message=FALSE, fig.pos="H"}
plt_q5f4
```

Examining the distribution of the three pollution variables together, it's clear that `hc` and `so2` could also deserve a log transform to be included in the model.

```{r q5t2, echo=FALSE}
kableExtra::kable(
  tab_q5t2,
  escape = FALSE,
  booktabs = TRUE,
  caption = "Estimates of coefficients for the model $\\mathrm{mort}\\sim\\log{(\\mathrm{hc})}+\\log{(\\mathrm{nox})}+\\log{(\\mathrm{so2})}$" # nolint
) |>
  kableExtra::kable_styling(latex_options = "hold_position")
```

<!--TODO: Finish this-->

# Question 6
